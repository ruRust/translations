---
layout: post
title: Announcing Rust 1.61.0
author: The Rust Release Team
release: 'true'
---

Команда Rust рада сообщить о новой версии языка — 1.61.0. Rust — это язык программирования, позволяющий каждому создавать надёжное и эффективное программное обеспечение.

Если у вас есть предыдущая версия Rust, установленная через <code>rustup</code>, то для обновления до версии 1.61.0 вам достаточно выполнить команду:

```console
rustup update stable
```

Если у вас ещё нет `rustup`, то можете установить его со [страницы](https://www.rust-lang.org/install.html) на нашем веб-сайте, а также ознакомиться с [подробным описанием выпуска 1.60.0](https://github.com/rust-lang/rust/blob/master/RELEASES.md#version-1610-2022-05-19) на GitHub.

Если вы хотите помочь нам протестировать будущие выпуски, вы можете использовать beta (`rustup default beta`) или nightly (`rustup default nightly`) канал. Пожалуйста, [сообщайте](https://github.com/rust-lang/rust/issues/new/choose) обо всех встреченных вами ошибках.

## Что стабилизировано в 1.61.0

### Пользовательские коды возврата из `main`

In the beginning, Rust `main` functions could only return the unit type `()` (either implicitly or explicitly), always indicating success in the exit status, and if you wanted otherwise you had to call `process::exit(code)`. Since Rust 1.26, `main` has been allowed to return a `Result`, where `Ok` translated to a C `EXIT_SUCCESS` and `Err` to `EXIT_FAILURE` (also debug-printing the error). Under the hood, these alternate return types were unified by an unstable `Termination` trait.

In this release, that `Termination` trait is finally stable, along with a more general `ExitCode` type that wraps platform-specific return types. That has `SUCCESS` and `FAILURE` constants, and also implements `From<u8>` for more arbitrary values. The `Termination` trait can also be implemented for your own types, allowing you to customize any kind of reporting before converting to an `ExitCode`.

Для примера здесь представлен типобезопасный вариант написания кодов возврата для [`git bisect run`](https://git-scm.com/docs/git-bisect#_bisect_run):

```rust
use std::process::{ExitCode, Termination};

#[repr(u8)]
pub enum GitBisectResult {
    Good = 0,
    Bad = 1,
    Skip = 125,
    Abort = 255,
}

impl Termination for GitBisectResult {
    fn report(self) -> ExitCode {
        // Здесь можно вывести сообщение
        ExitCode::from(self as u8)
    }
}

fn main() -> GitBisectResult {
    std::panic::catch_unwind(|| {
        todo!("test the commit")
    }).unwrap_or(GitBisectResult::Abort)
}
```

### Больше возможностей для `const fn`

Несколько инкрементальных особенностей было стабилизировано в этом выпуске для предоставления большей функциональности `const` функций:

- **Basic handling of `fn` pointers**: You can now create, pass, and cast function pointers in a `const fn`. For example, this could be useful to build compile-time function tables for an interpreter. However, it is still not permitted to call `fn` pointers.

- **Trait bounds**: You can now write trait bounds on generic parameters to `const fn`, such as `T: Copy`, where previously only `Sized` was allowed.

- **`dyn Trait` types**: Similarly, `const fn` can now deal with trait objects, `dyn Trait`.

- **`impl Trait` типы**: аргументы и возвращаемое значение `const fn` теперь могут быть непрозрачным `impl Trait` типом.

Note that the trait features do not yet support calling methods from those traits in a `const fn`.

See the [Constant Evaluation](https://doc.rust-lang.org/stable/reference/const_eval.html) section of the reference book to learn more about the current capabilities of `const` contexts, and future capabilities can be tracked in [rust#57563](https://github.com/rust-lang/rust/issues/57563).

### Static handles for locked stdio

The three standard I/O streams -- `Stdin`, `Stdout`, and `Stderr` -- each have a `lock(&self)` to allow more control over synchronizing read and writes. However, they returned lock guards with a lifetime borrowed from `&self`, so they were limited to the scope of the original handle. This was determined to be an unnecessary limitation, since the underlying locks were actually in static storage, so now the guards are returned with a `'static` lifetime, disconnected from the handle.

Например, общая ошибка, получаемая при попытке захватить управление и блокировку в одном выражении:

```rust
// error[E0716]: temporary value dropped while borrowed
let out = std::io::stdout().lock();
//        ^^^^^^^^^^^^^^^^^       - temporary value is freed at the end of this statement
//        |
//        creates a temporary which is freed while still in use
```

Now the lock guard is `'static`, not borrowing from that temporary, so this works!

### Стабилизированные API

The following methods and trait implementations are now stabilized:

- [`Pin::static_mut`](https://doc.rust-lang.org/1.61.0/std/pin/struct.Pin.html#method.static_mut)
- [`Pin::static_ref`](https://doc.rust-lang.org/1.61.0/std/pin/struct.Pin.html#method.static_ref)
- [`Vec::retain_mut`](https://doc.rust-lang.org/1.61.0/std/vec/struct.Vec.html#method.retain_mut)
- [`VecDeque::retain_mut`](https://doc.rust-lang.org/1.61.0/std/collections/struct.VecDeque.html#method.retain_mut)
- [`Write` для `Cursor<[u8; N]>`](https://doc.rust-lang.org/1.61.0/std/io/struct.Cursor.html#impl-Write-4)
- [`std::os::unix::net::SocketAddr::from_pathname`](https://doc.rust-lang.org/1.61.0/std/os/unix/net/struct.SocketAddr.html#method.from_pathname)
- [`std::process::ExitCode`](https://doc.rust-lang.org/1.61.0/std/process/struct.ExitCode.html)
- [`std::process::Termination`](https://doc.rust-lang.org/1.61.0/std/process/trait.Termination.html)
- [`std::thread::JoinHandle::is_finished`](https://doc.rust-lang.org/1.61.0/std/thread/struct.JoinHandle.html#method.is_finished)

Следующие ранее стабилизированные API стали `const`:

- [`<*const T>::offset`](https://doc.rust-lang.org/1.61.0/std/primitive.pointer.html#method.offset) и [`<*mut T>::offset`](https://doc.rust-lang.org/1.61.0/std/primitive.pointer.html#method.offset-1)
- [`<*const T>::wrapping_offset`](https://doc.rust-lang.org/1.61.0/std/primitive.pointer.html#method.wrapping_offset) и [`<*mut T>::wrapping_offset`](https://doc.rust-lang.org/1.61.0/std/primitive.pointer.html#method.wrapping_offset-1)
- [`<*const T>::add`](https://doc.rust-lang.org/1.61.0/std/primitive.pointer.html#method.add) и [`<*mut T>::add`](https://doc.rust-lang.org/1.61.0/std/primitive.pointer.html#method.add-1)
- [`<*const T>::sub`](https://doc.rust-lang.org/1.61.0/std/primitive.pointer.html#method.sub) и [`<*mut T>::sub`](https://doc.rust-lang.org/1.61.0/std/primitive.pointer.html#method.sub-1)
- [`<*const T>::wrapping_add`](https://doc.rust-lang.org/1.61.0/std/primitive.pointer.html#method.wrapping_add) и [`<*mut T>::wrapping_add`](https://doc.rust-lang.org/1.61.0/std/primitive.pointer.html#method.wrapping_add-1)
- [`<*const T>::wrapping_sub`](https://doc.rust-lang.org/1.61.0/std/primitive.pointer.html#method.wrapping_sub) и [`<*mut T>::wrapping_sub`](https://doc.rust-lang.org/1.61.0/std/primitive.pointer.html#method.wrapping_sub-1)
- [`<[T]>::as_mut_ptr`](https://doc.rust-lang.org/1.61.0/std/primitive.slice.html#method.as_mut_ptr)
- [`<[T]>::as_ptr_range`](https://doc.rust-lang.org/1.61.0/std/primitive.slice.html#method.as_ptr_range)
- [`<[T]>::as_mut_ptr_range`](https://doc.rust-lang.org/1.61.0/std/primitive.slice.html#method.as_mut_ptr_range)

### Прочие изменения

В выпуске Rust 1.61.0 есть и другие изменения: узнайте, что изменилось в [Rust](https://github.com/rust-lang/rust/blob/stable/RELEASES.md#version-1610-2022-05-19), [Cargo](https://github.com/rust-lang/cargo/blob/master/CHANGELOG.md#cargo-161-2022-05-19) и [Clippy](https://github.com/rust-lang/rust-clippy/blob/master/CHANGELOG.md#rust-161).

В следующем выпуске мы планируем повысить минимальные требования для ядра Linux до версии 3.2 и для glibc до 2.17. Будем рады получить вашу обратную связь в [rust#95026](https://github.com/rust-lang/rust/pull/95026).

### Участники 1.61.0

Многие люди собрались вместе, чтобы создать Rust 1.61.0. Без вас мы бы не справились. [Спасибо!](https://thanks.rust-lang.org/rust/1.61.0/)
